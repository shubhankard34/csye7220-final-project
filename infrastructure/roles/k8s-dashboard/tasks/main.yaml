
- name: Replace github oauth client id
  replace:
    dest: files/oauth2-proxy-deployment.yaml
    regexp: 'GIT_CLIENT_ID'
    replace: '{{ github_client_id }}'

- name: Replace github oauth client secret
  replace:
    dest: files/oauth2-proxy-deployment.yaml
    regexp: 'GIT_CLIENT_SECRET'
    replace: '{{ github_client_secret }}'

- name: Check for existing kubernetes-dashboard
  k8s_facts:
    api_version: v1
    kind: Service
    name: dashboard-kubernetes-dashboard
    namespace: kube-system
  register: kubernetes_dashboard

- name: Install K8s dashboard chart
  shell: helm install stable/kubernetes-dashboard --name=dash \
    --namespace=kube-system 
  when: kubernetes_dashboard.resources | length == 0

- name: Install oauth2 proxy deployment
  k8s:
    src: files/oauth2-proxy-deployment.yaml
    wait: yes

- name: Install oauth2 proxy svc
  k8s:
    src: files/oauth2-proxy-svc.yaml
    wait: yes

- name: Install oauth2 proxy ingress
  k8s:
    src: files/oauth2-proxy-ingress.yaml
    wait: yes

- name: Install oauth2 dashboard ingress
  k8s:
    src: files/dashboard-ingress.yaml
    wait: yes
